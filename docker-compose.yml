version: "3.1"
services:
  # compiling frontend resources
  frontendv2:
    tty: false
    build:
      context: ./bootstrap-ui-module-frontend
      dockerfile: ./Dockerfile
    command: ./build-prod.sh build:webjar
    volumes:
      - ./bootstrap-ui-module-frontend/src/main/frontend:/build/src/main/frontend
      - /build/src/main/frontend/node_modules
      - ./bootstrap-ui-module-frontend/src/main/resources:/build/src/main/resources
      - ./bootstrap-ui-module-frontend/target:/build/target

  webv2:
    ipc: host
    # TTY doesn't show pretty in bamboo
    tty: false
    build:
      context: .
      dockerfile: bootstrap-ui-module-frontend/src/main/frontend/test/e2e/web/Dockerfile
    ports:
      - "8080:8080"
    expose:
      - "8080"
    #    depends_on:
    #      - gulp
    volumes:
      - ./bootstrap-ui-module-test/target:/web
    networks:
      default:
        aliases:
          - bootstrapui-test.dev.foreach.be
  testv2:
    ipc: host
    # TTY doesn't show pretty in bamboo
    tty: false
    build:
      context: .
      dockerfile: bootstrap-ui-module-frontend/src/main/frontend/test/e2e/tests/Dockerfile
    depends_on:
      - webv2
    command: bash -c "./wait-for-it.sh -t 360 web:8080 -- run; ./node_modules/.bin/cypress run --project ./cypress --reporter junit --reporter-options mochaFile=cypress/out/test-results-[hash].xml; chmod -R 777 ./cypress"
    links:
      - webv2
    volumes:
      - ./bootstrap-ui-module-frontend/src/main/frontend/test/e2e/tests:/cypress


  frontend:
    build:
      context: .
      dockerfile: ./docker/Dockerfile.assets
    image: bootstrap-ui-module-assets
    command: yarn run build
    container_name: bootstrap-ui-module-assets-builder
    volumes:
      - ./bootstrap-ui-module/src/main/frontend:/build
      - ./bootstrap-ui-module/src/main/resources/views/static/BootstrapUiModule:/resources/views/static/BootstrapUiModule

  # executing e2e tests
  web:
    ipc: host
    # TTY doesn't show pretty in bamboo
    tty: false
    build:
      context: .
      dockerfile: bootstrap-ui-module/src/main/frontend/tests/e2e/web/Dockerfile
    ports:
      - "8080:8080"
    expose:
      - "8080"
    #    depends_on:
    #      - gulp
    volumes:
      - ./bootstrap-ui-module-test/target:/web
    networks:
      default:
        aliases:
          - bootstrapui-test.dev.foreach.be
  test:
    ipc: host
    # TTY doesn't show pretty in bamboo
    tty: false
    build:
      context: .
      dockerfile: bootstrap-ui-module/src/main/frontend/tests/e2e/tests/Dockerfile
    depends_on:
      - web
    command: bash -c "./wait-for-it.sh -t 360 web:8080 -- run; ./node_modules/.bin/cypress run --project ./cypress --reporter junit --reporter-options mochaFile=cypress/out/test-results-[hash].xml; chmod -R 777 ./cypress"
    links:
      - web
    volumes:
      - ./bootstrap-ui-module/src/main/frontend/tests/e2e/tests:/cypress
  cleanup:
    image: busybox:latest
    command: sh -c "echo Cleanup up /cypress/cypress/out; ls -al /cypress/cypress; rm -rf /cypress/cypress/out"
    volumes:
      - ./bootstrap-ui-module/src/main/frontend/tests/e2e/tests:/cypress
